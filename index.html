<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Neue Inhalte der Anton-Hansen-Schule</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        * { box-sizing: border-box; }
        body, html { margin: 0; padding: 0; font-family: 'Inter', sans-serif; background: #f0f4f8; }
        
        .menu-container {
            background: #002a5c;
            padding: 40px 20px 60px;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        
        .menu-container h2 { color: #fff; font-size: 2rem; margin-bottom: 30px; }
        
        .fabi-leon-promo {
            background: #f3f4f6;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 30px;
            max-width: 700px;
            width: 100%;
            text-align: center;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        }
        
        .fabi-leon-promo h3 { font-size: 1.25rem; color: #002a5c; margin: 0 0 10px; }
        .fabi-leon-links { display: flex; flex-wrap: wrap; justify-content: center; gap: 10px; margin-top: 15px; }
        .fabi-leon-links a {
            display: inline-flex;
            align-items: center;
            gap: 5px;
            padding: 8px 15px;
            border-radius: 20px;
            text-decoration: none;
            font-size: 0.9rem;
            font-weight: 600;
            transition: 0.2s;
        }
        .fabi-leon-links a.web { background: #fff; color: #002a5c; border: 1px solid #002a5c; }
        .fabi-leon-links a.web:hover { background: #e0e7ff; }
        .fabi-leon-links a.yt { background: #ff0000; color: #fff; }
        .fabi-leon-links a.yt:hover { background: #cc0000; }
        .fabi-leon-links a.insta { background: #E1306C; color: #fff; }
        .fabi-leon-links a.insta:hover { background: #a80a42; }
        .fabi-leon-links a.linktree { background: #607d8b; color: #fff; }
        .fabi-leon-links a.linktree:hover { background: #455a64; }
        
        .tab-navigation { display: flex; gap: 15px; margin-bottom: 30px; }
        .tab-button {
            font-family: 'Inter', sans-serif;
            font-size: 1rem;
            font-weight: 600;
            padding: 12px 25px;
            border-radius: 50px;
            border: 2px solid rgba(255,255,255,0.5);
            background: transparent;
            color: rgba(255,255,255,0.8);
            cursor: pointer;
            transition: 0.3s;
        }
        .tab-button:hover { background: rgba(255,255,255,0.1); color: #fff; }
        .tab-button.active { background: #fff; color: #002a5c; border-color: #fff; }
        
        .tab-content-wrapper { width: 100%; max-width: 700px; }
        .tab-panel {
            display: none;
            background: #fff;
            border-radius: 16px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            position: relative;
            min-height: 250px;
        }
        .tab-panel.active { display: block; }
        
        /* --- GEÄNDERT --- (Für Zeitstempel) */
        .panel-header { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            margin-bottom: 20px; 
            gap: 10px; 
            flex-wrap: wrap;
        }
        
        /* --- NEU --- (Für Zeitstempel) */
        .last-updated {
            font-size: 0.8rem;
            color: #666;
            text-align: left;
            flex-grow: 1;
        }
        
        .refresh-button {
            background: #95a5a6;
            color: #fff;
            border: none;
            padding: 8px 15px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 500;
            display: inline-flex;
            align-items: center;
            gap: 5px;
            flex-shrink: 0;
        }
        .refresh-button:hover { background: #7f8c8d; }
        .refresh-button:disabled { opacity: 0.6; cursor: not-allowed; }
        
        .status-message {
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(255,255,255,0.95);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10;
            color: #333;
            font-size: 1.1rem;
            border-radius: 16px;
        }
        .tab-panel.loaded .status-message { opacity: 0; pointer-events: none; }
        
        .feed-list { list-style: none; padding: 0; margin: 0; }
        .feed-item {
            display: flex;
            gap: 15px;
            padding: 15px 0;
            border-bottom: 1px solid #eee;
        }
        .feed-item:last-child { border-bottom: none; }
        .feed-item img {
            width: 120px;
            height: 68px;
            object-fit: cover;
            border-radius: 8px;
            cursor: pointer;
            transition: 0.2s;
        }
        .feed-item img:hover { transform: scale(1.05); }
        .feed-item.spotify img { width: 80px; height: 80px; }
        
        .feed-item-content { flex: 1; }
        .title-link {
            font-size: 1rem;
            font-weight: 600;
            color: #333;
            text-decoration: none;
            display: block;
            margin-bottom: 5px;
        }
        .title-link:hover { color: #002a5c; }
        .feed-item-date { font-size: 0.85rem; color: #777; margin-bottom: 8px; }
        
        .article-link-button {
            background: #0056b3;
            color: #fff;
            border: none;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            text-decoration: none;
        }
        .article-link-button:hover { background: #004085; transform: translateY(-1px); }
        
        .load-more-button {
            width: 100%;
            background: #002a5c;
            color: #fff;
            border: none;
            padding: 12px;
            border-radius: 8px;
            font-weight: 600;
            margin-top: 20px;
            cursor: pointer;
        }
        .load-more-button:hover { background: #003d7c; }
        
        .panel-footer {
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid #eee;
            text-align: center;
        }
        .channel-link {
            padding: 12px 30px;
            border-radius: 50px;
            font-weight: 600;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            transition: 0.3s;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        }
        .channel-link.youtube { background: #ff0000; color: #fff; }
        .channel-link.youtube:hover { background: #cc0000; transform: translateY(-2px); }
        .channel-link.spotify { background: #1DB954; color: #fff; }
        .channel-link.spotify:hover { background: #17893d; transform: translateY(-2px); }
        
        .modal {
            display: none;
            position: fixed;
            z-index: 100;
            left: 0; top: 0;
            width: 100%; height: 100%;
            background: rgba(0,0,0,0.6);
            justify-content: center;
            align-items: center;
            opacity: 0;
            transition: 0.3s;
        }
        .modal.active { display: flex; opacity: 1; }
        .modal-content {
            background: #fff;
            padding: 30px;
            border-radius: 12px;
            width: 90%;
            max-width: 500px;
            max-height: 80vh;
            overflow-y: auto;
            position: relative;
        }
        .close-button {
            position: absolute;
            top: 10px; right: 15px;
            font-size: 28px;
            cursor: pointer;
            background: none;
            border: none;
            color: #aaa;
        }
        .close-button:hover { color: #333; }
        .modal-content h3 { color: #002a5c; margin-top: 0; padding-right: 30px; }
        .modal-link-list { display: flex; flex-direction: column; gap: 10px; }
        .modal-link-list a {
            background: #e0f2f7;
            color: #002a5c;
            padding: 12px 15px;
            border-radius: 8px;
            text-decoration: none;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .modal-link-list a:hover { background: #cce9f4; }
        .modal-loading { text-align: center; padding: 20px; color: #777; }
        
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        .fa-spin { animation: spin 1s linear infinite; }
    </style>
</head>
<body>
    <div class="menu-container">
        <h2>Neue Inhalte</h2>

        <div class="tab-navigation">
            <button class="tab-button active" data-tab="youtube">
                <i class="fa-brands fa-youtube"></i> Videos
            </button>
            <button class="tab-button" data-tab="spotify">
                <i class="fa-brands fa-spotify"></i> Podcast
            </button>
        </div>
        
        <div class="fabi-leon-promo">
            <h3>Produziert von Fabi & Leon</h3>
            <p style="font-size:0.9rem;color:#555;margin:0;">Das Management hinter YouTube und Spotify.</p>
            <div class="fabi-leon-links">
                <a href="https://www.fabiundleon.de" class="web" target="_blank">
                    <i class="fa-solid fa-earth-europe"></i> Webseite
                </a>
                <a href="https://youtube.com/@FabiUndLeon?sub_confirmation=1" class="yt" target="_blank">
                    <i class="fa-brands fa-youtube"></i> YouTube
                </a>
                <a href="https://instagram.com/fabiundleon" class="insta" target="_blank">
                    <i class="fa-brands fa-instagram"></i> Instagram
                </a>
                <a href="https://wonderl.ink/@FabiUndLeon" class="linktree" target="_blank">
                    <i class="fa-solid fa-link"></i> Alle Links
                </a>
            </div>
        </div>

        <div class="tab-content-wrapper">
            <div class="tab-panel active" id="youtube">
                <div class="status-message"><i class="fa-solid fa-spinner fa-spin"></i> Lade Videos...</div>
                <!-- --- GEÄNDERT --- (Panel-Header für Zeitstempel) -->
                <div class="panel-header">
                    <div class="last-updated" id="youtube-last-updated"></div>
                    <button class="refresh-button" data-tab="youtube">
                        <i class="fa-solid fa-arrows-rotate"></i> Aktualisieren
                    </button>
                </div>
                <ul class="feed-list" id="youtube-feed-list"></ul>
                <button class="load-more-button" data-tab="youtube" style="display:none;">Ältere anzeigen</button>
                <div class="panel-footer">
                    <a href="https://youtube.com/@AHS-OTW?sub_confirmation=1" class="channel-link youtube" target="_blank">
                        <i class="fa-brands fa-youtube"></i> Zum YouTube-Kanal
                    </a>
                </div>
            </div>

            <div class="tab-panel" id="spotify">
                <div class="status-message"><i class="fa-solid fa-spinner fa-spin"></i> Lade Folgen...</div>
                 <!-- --- GEÄNDERT --- (Panel-Header für Zeitstempel) -->
                <div class="panel-header">
                    <div class="last-updated" id="spotify-last-updated"></div>
                    <button class="refresh-button" data-tab="spotify">
                        <i class="fa-solid fa-arrows-rotate"></i> Aktualisieren
                    </button>
                </div>
                <ul class="feed-list" id="spotify-feed-list"></ul>
                <button class="load-more-button" data-tab="spotify" style="display:none;">Ältere anzeigen</button>
                <div class="panel-footer">
                    <a href="https://open.spotify.com/show/1gg6Ky5FUDwSekAQ9IdEdv" class="channel-link spotify" target="_blank">
                        <i class="fa-brands fa-spotify"></i> Zum Spotify-Podcast
                    </a>
                </div>
            </div>
        </div>
    </div>

    <div id="multiLinkModal" class="modal">
        <div class="modal-content">
            <button class="close-button">&times;</button>
            <h3>Beitrag lesen</h3>
            <div class="modal-link-list"></div>
        </div>
    </div>

    <script>
        const API_KEY = 'AIzaSyCyQLP8Tk1u7-VWgGRfleZ6_ojcjkIDre4';
        const CHANNEL_ID = 'UC9GtyN6irUK93FwmYsnTHkw';
        
        // --- GEÄNDERT --- (Wunsch: 3 Items laden)
        const ITEMS_PER_LOAD = 3;
        
        let cache = {};
        let limits = { youtube: ITEMS_PER_LOAD, spotify: ITEMS_PER_LOAD };

        // --- NEU --- (Helfer-Funktion für Zeitstempel)
        function updateTimestamp(tab, dateObj) {
            const el = document.getElementById(`${tab}-last-updated`);
            if (el) {
                const options = { day: '2-digit', month: '2-digit', hour: '2-digit', minute: '2-digit' };
                el.textContent = `Zuletzt akt.: ${dateObj.toLocaleString('de-DE', options)} Uhr`;
            }
        }

        // Links extrahieren (Unverändert)
        function extractLinks(text) {
            if (!text) return [];
            const matches = text.match(/https?:\/\/(www\.)?anton-hansen-schule\.de[^\s<>")]+/gi) || [];
            return [...new Set(matches)];
        }

        // Seitentitel abrufen (Unverändert)
        async function getTitle(url) {
            try {
                const r = await fetch('https://api.allorigins.win/get?url=' + encodeURIComponent(url));
                const d = await r.json();
                const doc = new DOMParser().parseFromString(d.contents, 'text/html');
                return doc.querySelector('title')?.textContent?.trim() || 'Beitrag öffnen';
            } catch { return 'Beitrag öffnen'; }
        }

        // Modal öffnen (Unverändert)
        window.openModal = async function(links) {
            const modal = document.getElementById('multiLinkModal');
            const list = modal.querySelector('.modal-link-list');
            
            list.innerHTML = '<div class="modal-loading"><i class="fa-solid fa-spinner fa-spin"></i> Lade...</div>';
            modal.classList.add('active');
            
            const items = await Promise.all(links.map(async l => ({ link: l, title: await getTitle(l) })));
            list.innerHTML = items.map(({link, title}) => 
                `<a href="${link}" target="_blank"><i class="fa-solid fa-file-lines"></i> ${title}</a>`
            ).join('');
        };

        // YouTube laden (--- GEÄNDERT --- Logik korrigiert + Zeitstempel)
        async function loadYouTube(refresh = false) {
            const panel = document.getElementById('youtube');
            const btn = panel.querySelector('.refresh-button');
            const icon = btn.querySelector('i');
            
            if (cache.youtube && !refresh) {
                renderYouTube(cache.youtube);
                if (cache.youtube_timestamp) { // Zeitstempel aus Cache laden
                    updateTimestamp('youtube', cache.youtube_timestamp);
                }
                panel.classList.add('loaded'); // Lade-Spinner sicher entfernen
                return;
            }
            
            panel.classList.remove('loaded');
            btn.disabled = true;
            icon.classList.add('fa-spin');
            
            try {
                // RSS laden
                const rssUrl = `https://www.youtube.com/feeds/videos.xml?channel_id=${CHANNEL_ID}`;
                const r1 = await fetch('https://api.rss2json.com/v1/api.json?rss_url=' + encodeURIComponent(rssUrl));
                const rssData = await r1.json();
                
                if (rssData.status !== 'ok') throw new Error('RSS failed');
                
                // Video IDs extrahieren
                const videoIds = rssData.items.map(item => {
                    const match = item.link.match(/v=([^&]+)/);
                    return match ? match[1] : null;
                }).filter(Boolean);
                
                console.log('Video IDs:', videoIds);
                
                // API Details laden (nur wenn IDs vorhanden sind)
                let apiData = { items: [] }; // Fallback
                if (videoIds.length > 0) {
                     const apiUrl = `https://www.googleapis.com/youtube/v3/videos?part=snippet&id=${videoIds.join(',')}&key=${API_KEY}`;
                     const r2 = await fetch(apiUrl);
                     apiData = await r2.json();
                     console.log('YouTube API:', apiData);
                } else {
                    console.log('Keine Video-IDs gefunden, überspringe API-Aufruf.');
                }
                
                // Descriptions zusammenführen
                const descs = {};
                if (apiData.items) {
                    apiData.items.forEach(v => { descs[v.id] = v.snippet.description; });
                }
                
                // Daten mergen (wichtig: description wird hier zugewiesen)
                const items = rssData.items.map(item => {
                    const videoId = item.link.match(/v=([^&]+)/)?.[1];
                    return {
                        ...item,
                        videoId,
                        description: descs[videoId] || '' // <-- Hier!
                    };
                });
                
                console.log('Final items:', items);
                
                cache.youtube = items;
                
                // --- NEU --- Zeitstempel setzen
                const timestamp = new Date();
                cache.youtube_timestamp = timestamp;
                updateTimestamp('youtube', timestamp);

                renderYouTube(items);
                panel.classList.add('loaded');
                
            } catch (err) {
                console.error('YouTube Error:', err);
                panel.querySelector('.status-message').innerHTML = '<i class="fa-solid fa-circle-exclamation"></i> Fehler beim Laden';
            } finally {
                icon.classList.remove('fa-spin');
                btn.disabled = false;
            }
        }

        // YouTube rendern (Unverändert)
        function renderYouTube(items) {
            const list = document.getElementById('youtube-feed-list');
            const btn = document.querySelector('#youtube .load-more-button');
            
            list.innerHTML = '';
            const show = items.slice(0, limits.youtube);
            
            show.forEach(item => {
                const li = document.createElement('li');
                li.className = 'feed-item';
                
                const date = new Date(item.pubDate).toLocaleDateString('de-DE');
                const links = extractLinks(item.description); // <-- Nutzt die description
                
                let linkBtn = '';
                if (links.length === 1) {
                    linkBtn = `<a href="${links[0]}" target="_blank" class="article-link-button">
                        <i class="fa-solid fa-file-lines"></i> Beitrag dazu lesen
                    </a>`;
                } else if (links.length > 1) {
                    const linksJson = JSON.stringify(links).replace(/"/g, '&quot;');
                    linkBtn = `<button class="article-link-button" onclick="openModal(${linksJson})">
                        <i class="fa-solid fa-file-lines"></i> Beitrag lesen + ${links.length - 1} weitere
                    </button>`;
                }
                
                li.innerHTML = `
                    <img src="${item.thumbnail}" onclick="window.open('${item.link}', '_blank')">
                    <div class="feed-item-content">
                        <a href="${item.link}" target="_blank" class="title-link">${item.title}</a>
                        <div class="feed-item-date">${date}</div>
                        ${linkBtn}
                    </div>
                `;
                list.appendChild(li);
            });
            
            btn.style.display = show.length < items.length ? 'block' : 'none';
        }

        // Spotify laden (--- GEÄNDERT --- Zeitstempel)
        async function loadSpotify(refresh = false) {
            const panel = document.getElementById('spotify');
            const btn = panel.querySelector('.refresh-button');
            const icon = btn.querySelector('i');
            
            if (cache.spotify && !refresh) {
                renderSpotify(cache.spotify);
                 if (cache.spotify_timestamp) { // Zeitstempel aus Cache laden
                    updateTimestamp('spotify', cache.spotify_timestamp);
                }
                panel.classList.add('loaded');
                return;
            }
            
            panel.classList.remove('loaded');
            btn.disabled = true;
            icon.classList.add('fa-spin');
            
            try {
                const rssUrl = 'https://anchor.fm/s/105dbc5d0/podcast/rss';
                const r = await fetch('https://api.rss2json.com/v1/api.json?rss_url=' + encodeURIComponent(rssUrl));
                const data = await r.json();
                
                console.log('Spotify RSS:', data);
                
                if (data.status !== 'ok') throw new Error('RSS failed');
                
                cache.spotify = data.items;

                // --- NEU --- Zeitstempel setzen
                const timestamp = new Date();
                cache.spotify_timestamp = timestamp;
                updateTimestamp('spotify', timestamp);

                renderSpotify(data.items);
                panel.classList.add('loaded');
                
            } catch (err) {
                console.error('Spotify Error:', err);
                panel.querySelector('.status-message').innerHTML = '<i class="fa-solid fa-circle-exclamation"></i> Fehler beim Laden';
            } finally {
                icon.classList.remove('fa-spin');
                btn.disabled = false;
            }
        }

        // Spotify rendern (Unverändert)
        function renderSpotify(items) {
            const list = document.getElementById('spotify-feed-list');
            const btn = document.querySelector('#spotify .load-more-button');
            
            list.innerHTML = '';
            const show = items.slice(0, limits.spotify);
            
            show.forEach(item => {
                const li = document.createElement('li');
                li.className = 'feed-item spotify';
                
                const date = new Date(item.pubDate).toLocaleDateString('de-DE');
                
                li.innerHTML = `
                    <img src="${item.thumbnail || item.enclosure?.link || ''}" onclick="window.open('${item.link}', '_blank')">
                    <div class="feed-item-content">
                        <a href="${item.link}" target="_blank" class="title-link">${item.title}</a>
                        <div class="feed-item-date">${date}</div>
                    </div>
                `;
                list.appendChild(li);
            });
            
            btn.style.display = show.length < items.length ? 'block' : 'none';
        }

        // Events (--- GEÄNDERT --- Refresh setzt Limit zurück)
        document.addEventListener('DOMContentLoaded', () => {
            // Tabs
            document.querySelectorAll('.tab-button').forEach(btn => {
                btn.addEventListener('click', () => {
                    const tab = btn.dataset.tab;
                    document.querySelectorAll('.tab-button').forEach(b => b.classList.remove('active'));
                    document.querySelectorAll('.tab-panel').forEach(p => p.classList.remove('active'));
                    btn.classList.add('active');
                    document.getElementById(tab).classList.add('active');
                    if (tab === 'youtube') loadYouTube();
                    if (tab === 'spotify') loadSpotify();
                });
            });
            
            // Refresh
            document.querySelectorAll('.refresh-button').forEach(btn => {
                btn.addEventListener('click', () => {
                    const tab = btn.dataset.tab;
                    limits[tab] = ITEMS_PER_LOAD; // Wichtig: Setzt beim Refresh auf 3 zurück
                    if (tab === 'youtube') loadYouTube(true);
                    if (tab === 'spotify') loadSpotify(true);
                });
            });
            
            // Load More (lädt 3 weitere)
            document.querySelectorAll('.load-more-button').forEach(btn => {
                btn.addEventListener('click', () => {
                    const tab = btn.dataset.tab;
                    limits[tab] += ITEMS_PER_LOAD;
                    if (tab === 'youtube') renderYouTube(cache.youtube);
                    if (tab === 'spotify') renderSpotify(cache.spotify);
                });
            });
            
            // Modal schließen
            document.querySelector('.close-button').addEventListener('click', () => {
                document.getElementById('multiLinkModal').classList.remove('active');
            });
            
            document.getElementById('multiLinkModal').addEventListener('click', (e) => {
                if (e.target.id === 'multiLinkModal') {
                    e.target.classList.remove('active');
                }
            });
            
            // Initial laden
            loadYouTube();
        });
    </script>
</body>
</html>
